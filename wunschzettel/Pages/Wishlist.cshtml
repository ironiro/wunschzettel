@page "{id}"
@model WishlistModel
@{
    ViewData["Title"] = "Wunschzettel";
}

<div class="site-content py-4">
    <div class="card w-100 shadow-sm" style="max-width:720px;">
        <div class="card-body">
            <h2 class="h5 text-center mb-3">Wunschzettel</h2>

            @if (Model.Wishlist == null)
            {
                <div class="alert alert-warning">Wunschzettel nicht gefunden.</div>
            }
            else
            {
                <h3 class="h6">@Model.Wishlist.Title</h3>
                <p class="text-muted small">Erstellt: @Model.Wishlist.CreatedAt.ToLocalTime().ToString("g")</p>

                <ul class="list-group">
                    @if (Model.Wishlist.Gifts?.Any() != true)
                    {
                        <li class="list-group-item">Keine Geschenke vorhanden.</li>
                    }
                    else
                    {
                                                        @foreach (var g in Model.Wishlist.Gifts)
                                                        {
                                                                <li class="list-group-item d-flex justify-content-between align-items-start">
                                                                        <div>
                                                                                <strong class="me-2">@g.Name</strong>
                                                                    @if (!string.IsNullOrWhiteSpace(g.Note)) { <div class="small text-muted">@g.Note</div> }
                                                                    @if (g.Price.HasValue) { <div class="small text-muted">Preis: @g.Price.Value.ToString("C")</div> }
                                                                    @if (!string.IsNullOrWhiteSpace(g.Link)) { <div class="small mt-1"><a href="@g.Link" target="_blank" rel="noopener noreferrer">Im Shop ansehen</a></div> }
                                                                    @if (g.IsBought && !string.IsNullOrWhiteSpace(g.BoughtBy)) { <div class="small text-success mt-1">Gekauft von: @g.BoughtBy</div> }
                                                                        </div>
                                                                        <div class="btn-group btn-group-sm" role="group">
                                                                                @if (!g.IsBought)
                                                                                {
                                                                                    <button type="button" class="btn btn-outline-success mark-bought-btn" data-gift-id="@g.Id" data-gift-name="@g.Name">Gekauft</button>
                                                                                }
                                                                                else
                                                                                {
                                                                                    <form method="post" asp-page-handler="UnsetBought">
                                                                                        <input type="hidden" name="giftId" value="@g.Id" />
                                                                                        <button type="submit" class="btn btn-outline-secondary">Rückgängig</button>
                                                                                    </form>
                                                                                }

                                                                                <form method="post" asp-page-handler="RemoveGift" class="remove-gift-form" data-gift-name="@g.Name">
                                                                                        <input type="hidden" name="giftId" value="@g.Id" />
                                                                                        <button type="button" class="btn btn-outline-danger remove-btn">Entfernen</button>
                                                                                </form>
                                                                        </div>
                                                                </li>
                                                        }
                    }
                </ul>

                                <!-- Delete confirmation modal -->
                                <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Wirklich löschen?</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                            </div>
                                            <div class="modal-body" id="confirmDeleteModalBody">
                                                Möchten Sie dieses Geschenk wirklich löschen?
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                                                <button id="confirmDelete" type="button" class="btn btn-danger">Löschen</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Mark bought modal -->
                                <div class="modal fade" id="markBoughtModal" tabindex="-1" aria-hidden="true" data-open-id="@(ViewData["OpenMarkModal"] ?? "")" data-error="@(ViewData["MarkBuyerError"] ?? "")">
                                    <div class="modal-dialog modal-dialog-centered">
                                        <div class="modal-content">
                                            <form method="post" asp-page-handler="MarkBought">
                                                <div class="modal-header">
                                                    <h5 class="modal-title">Als gekauft markieren</h5>
                                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <input type="hidden" id="markGiftId" name="giftId" />
                                                    <div class="mb-2"><label for="buyerName" class="form-label">Gekauft von</label>
                                                        <input id="buyerName" name="buyer" type="text" class="form-control" placeholder="Name eingeben" required aria-required="true" /></div>
                                                    <div id="markBoughtError" class="text-danger small mt-1">@(ViewData["MarkBuyerError"] ?? "")</div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                                                    <button type="submit" class="btn btn-success">Speichern</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                <hr />
                <h4 class="h6 mt-3">Geschenk hinzufügen</h4>
                <form method="post" asp-page-handler="AddGift" class="mt-2">
                    <input type="hidden" asp-for="Id" />
                    <input asp-for="NewGift.Name" class="form-control" placeholder="Name des Geschenks" />
                    <input asp-for="NewGift.Link" type="url" class="form-control" placeholder="Link zum Shop (optional)" />
                    <input asp-for="NewGift.Note" class="form-control" placeholder="Anmerkung (optional)" />
                    <input asp-for="NewGift.Price" class="form-control" placeholder="Preis (optional)" />
                    <button type="submit" class="btn btn-primary mt-2">Hinzufügen</button>
                </form>
            }
        </div>
    </div>
</div>
